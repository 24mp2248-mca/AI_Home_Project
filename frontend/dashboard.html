<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>AI Home Planner - Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-top: 40px;
        }

        .project-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .project-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.1);
        }

        .project-card h3 {
            margin-bottom: 12px;
            color: #fff;
        }

        .project-meta {
            color: #b0b0b0;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="bg-gradient">
        <div class="bg-orb"></div>
    </div>

    <div class="container">
        <header>
            <div class="logo">
                <span class="logo-icon">üè†</span>
                Dashboard
            </div>
            <nav>
                <a href="upload.html" class="nav-btn">+ New Project</a>
                <a href="#" onclick="logout()">Logout</a>
            </nav>
        </header>

        <section class="hero" style="padding: 40px 0; text-align: left;">
            <h1 id="welcome-msg" style="font-size: 2.5rem;">My Projects</h1>
        </section>

        <div class="dashboard-grid" id="project-list">
            <!-- Projects injected here -->
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:8000";

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }

        async function loadDashboard() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            try {
                // Get User Info
                const userRes = await fetch(`${API_URL}/users/me/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!userRes.ok) throw new Error('Auth failed');
                const user = await userRes.json();
                document.getElementById('welcome-msg').innerText = `Welcome, ${user.username}`;

                // Get Projects
                const projRes = await fetch(`${API_URL}/projects/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const projects = await projRes.json();

                const list = document.getElementById('project-list');
                list.innerHTML = projects.length ? '' : '<p style="color:#b0b0b0">No projects yet. Start a new one!</p>';

                projects.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'project-card';
                    card.innerHTML = `
                        <h3>${p.name}</h3>
                        <div class="project-meta">ID: ${p.id}</div>
                        <button class="btn btn-secondary" onclick="loadProject(${p.id})">Open 3D Model</button>
                    `;
                    list.appendChild(card);
                });

            } catch (err) {
                console.error(err);
                logout();
            }
        }

        async function loadProject(id) {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                // 1. Fetch project details
                // Note: We need an endpoint to get a single project, or we can find it in the list if we store it.
                // For now, let's fetch the list again or finding it if we have it. 
                // BETTER: Let's assume we can pass the data directly or fetch it.
                // The current API /projects/ returns the full list with data.

                // Let's iterate the 'projects' list we already fetched? 
                // Actually, to be safe, let's just fetch the list again and find it, or simply pass the data object if we had it in memory.
                // But efficient way: The projects list response contained the 'data' field.

                // Let's refactor to fetch the specific project if we add a GET /projects/{id} endpoint, 
                // but since we don't have that yet, let's find it in the DOM or re-fetch list.

                // Simplest approach without changing backend: Re-fetch list and find by ID.
                const res = await fetch(`${API_URL}/projects/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const projects = await res.json();
                const project = projects.find(p => p.id === id);

                if (project && project.data) {
                    // 2. Store in localStorage (matching upload.html behavior)
                    // The backend stores the 'data' dict which contains 'rooms' etc.

                    // layout_3d_data structure from backend: { house: {}, rooms: [...] }
                    // We need to map this to what 'visualization.html' expects.
                    // visualization.html reads 'roomData' (rooms array) and 'projectInfo'.

                    // user project.data usually contains the full JSON from layout_to_3d
                    const layoutData = project.data; // This should be the 3D layout

                    if (layoutData.rooms) {
                        localStorage.setItem('roomData', JSON.stringify(layoutData.rooms));
                    }

                    // Create project info
                    const projInfo = {
                        filename: project.name,
                        timestamp: layoutData.timestamp || new Date().toISOString(),
                        processed_image_url: layoutData.processed_image_url || ''
                    };
                    localStorage.setItem('projectInfo', JSON.stringify(projInfo));

                    // 3. Redirect
                    window.location.href = 'visualization.html';
                } else {
                    alert("Project data not found!");
                }
            } catch (err) {
                console.error(err);
                alert("Failed to load project");
            }
        }

        loadDashboard();
    </script>
</body>

</html>